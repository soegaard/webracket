#!/bin/bash
set -euo pipefail

STAMP=$(date +%s)
OUT_DIR="../local"
OLD_SITE_NEW_DIR="../../web-site/local/new"

format_generated_output() {
  sed -E 's#^Generated (.+) and (.+) \((.+ docs)\)\.$#Generated\n  \1\n  \2 \n  (\3).#'
}

echo "-- Generating FFI doc pages --"
racket generate-ffi-doc-pages.rkt | format_generated_output
racket generate-ffi-doc-pages-structured.rkt | format_generated_output

cat > examples/minischeme/build-id.rkt <<EOF
;; Auto-generated by web-site-new/src/build.sh
(define minischeme-build-id "${STAMP}")
EOF

echo "-- Compiling web-site.rkt --"
racket ../../webracket.rkt --browser --ffi xtermjs --ffi dom --ffi standard web-site.rkt

perl -0777 -i -pe "s/web-site\\.wasm\"/web-site.wasm?v=${STAMP}\"/g" web-site.html
# Keep `lang="en"` in the static HTML shell for baseline accessibility before
# WebRacket/Wasm initializes the page content.
perl -0777 -i -pe 's@<html>@<html lang="en">@s' web-site.html
# Keep a base style in the static HTML shell so first paint is close to the
# runtime theme before WebRacket/Wasm injects the full CSS.
perl -0777 -i -pe 's~<head>.*?</head>~<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><style>:root{--rk-bg:#f6f5f1;--rk-surface:#ffffff;--rk-text:#1f2328;--rk-muted:#5a6470;--rk-link:#114b7a;--rk-link-hover:#8b1a1a;--rk-accent:#8b1a1a;--rk-border:#d6d6d1;--rk-code-bg:#f1efe9;--rk-shadow:0 10px 28px rgba(0,0,0,0.08);}*{box-sizing:border-box;}html,body{margin:0;min-height:100%;background:linear-gradient(180deg,#f4f3ef 0%,#f8f8f6 32%,#ffffff 100%);color:var(--rk-text);}body{line-height:1.62;font-family:\"Lucida Grande\",\"Lucida Sans Unicode\",\"Trebuchet MS\",Verdana,sans-serif;-webkit-font-smoothing:antialiased;max-width:1280px;padding:0 1.2rem 2.2rem;margin:0 auto;}main,article,section,nav,aside,header,footer{max-width:100%;}h1,h2,h3,h4,h5,h6{font-family:Georgia,\"Times New Roman\",Times,serif;line-height:1.24;color:#212429;margin-top:1.1em;margin-bottom:.45em;}h1{font-size:2rem;border-bottom:2px solid #b61e1e;padding-bottom:.25rem;}h2{font-size:1.52rem;border-bottom:1px solid #ddd7cd;padding-bottom:.2rem;}h3{font-size:1.25rem;}p,li,dt,dd{color:var(--rk-text);}a{color:var(--rk-link);text-decoration:none;border-bottom:1px solid rgba(17,75,122,.25);transition:color .15s ease,border-color .15s ease;}a:hover,a:focus-visible{color:var(--rk-link-hover);border-color:rgba(139,26,26,.5);}code,kbd,samp,pre{font-family:\"Fira Code\",\"Consolas\",\"Menlo\",monospace;}code,kbd,samp{background:var(--rk-code-bg);border:1px solid #dfdbcf;border-radius:4px;padding:.1rem .32rem;font-size:.94em;}pre{background:var(--rk-code-bg);border:1px solid #dfdbcf;border-left:4px solid #b61e1e;border-radius:8px;padding:.85rem 1rem;overflow:auto;}table{width:100%;border-collapse:collapse;background:var(--rk-surface);border:1px solid var(--rk-border);border-radius:8px;overflow:hidden;}th,td{padding:.52rem .62rem;border-bottom:1px solid #e6e3dc;text-align:left;}th{background:#f2eee4;color:#3a3d44;font-weight:700;}tr:nth-child(even) td{background:#fbfaf7;}hr{border:0;border-top:1px solid #d8d4ca;margin:1.5rem 0;}button,.button,input[type=\"button\"],input[type=\"submit\"]{font:inherit;color:#fff;background:#8b1a1a;border:1px solid #751414;border-radius:7px;padding:.42rem .75rem;cursor:pointer;}button:hover,.button:hover,input[type=\"button\"]:hover,input[type=\"submit\"]:hover{background:#701414;}input,select,textarea{font:inherit;color:var(--rk-text);background:#fff;border:1px solid #cfc9bc;border-radius:6px;padding:.42rem .55rem;}blockquote{margin:1rem 0;padding:.75rem 1rem;border-left:4px solid #be9d5a;background:#f9f6ef;color:#38414a;}img,svg,canvas{max-width:100%;height:auto;}#app,.app,.container,.content,.docs-content,.docs-main,.docs-layout,.hero,.card,.panel,.toc-card,.example-card{background:var(--rk-surface);border:1px solid var(--rk-border);border-radius:10px;box-shadow:var(--rk-shadow);}header,.site-header,.topbar,.navbar,.nav,.docs-header{background:linear-gradient(180deg,#f9f7f2,#f1eee5);border-bottom:1px solid #d8d2c6;}nav a,.nav a,.menu a{font-weight:600;border-bottom:none;padding:.2rem .15rem;}nav a:hover,.nav a:hover,.menu a:hover{color:#8b1a1a;}footer,.site-footer{color:var(--rk-muted);border-top:1px solid #d9d5cb;padding-top:1rem;margin-top:2rem;}::selection{background:#f7d8a8;color:#2a1a10;}@media (max-width:900px){body{padding:0 .85rem 1.4rem;}h1{font-size:1.7rem;}h2{font-size:1.34rem;}table{font-size:.95rem;display:block;overflow-x:auto;}}</style></head>~s' web-site.html

ROUTE_ALIASES=(
  community
  documentation
  documentation-webracket-glance
  documentation-compiler-overview
  documentation-js-ffi
  documentation-ffi-standard
  documentation-ffi-dom
  documentation-ffi-js
  documentation-ffi-math
  documentation-ffi-jsxgraph
  documentation-ffi-xtermjs
  documentation-extended-example-jsxgraph-board-points
  documentation-extended-example-jsxgraph-geometry-constructors
  examples
  canvas-hexagons
  formula1
  implementation-status
  installation
  mathjax
  matrix-rain
  minischeme
  quick-start
  space-invaders
  xtermjs-demo
)

for page in "${ROUTE_ALIASES[@]}"; do
  cp web-site.html "${page}.html"
done

echo "-- Copying Assets --"
rm -rf "${OUT_DIR}"
mkdir -p "${OUT_DIR}/assets/favicon"
mkdir -p "${OUT_DIR}/assets/examples/screenshots"
mkdir -p "${OUT_DIR}/assets/vendor/jsxgraph"
mkdir -p "${OUT_DIR}/css/fonts"

cp web-site.wasm "${OUT_DIR}"
cp web-site.html "${OUT_DIR}/index.html"
cp web-site.html "${OUT_DIR}/web-site.html"
cp css/app.css "${OUT_DIR}/css/app.css"
cp css/styles.css "${OUT_DIR}/css/styles.css"
cp css/fonts/fonts.css "${OUT_DIR}/css/fonts/fonts.css"
cp assets/favicon/* "${OUT_DIR}/assets/favicon/"
cp assets/favicon/favicon.ico "${OUT_DIR}/favicon.ico"
cp assets/hex-racket-wasm-logo.svg "${OUT_DIR}/assets/hex-racket-wasm-logo.svg"
cp ../../assets/screenshots/examples/* "${OUT_DIR}/assets/examples/screenshots/"
cp ../../extras/jsxgraph/docs/static/jsxgraphcore.js "${OUT_DIR}/assets/vendor/jsxgraph/jsxgraphcore.js"
cp ../../extras/jsxgraph/docs/static/jsxgraph.css "${OUT_DIR}/assets/vendor/jsxgraph/jsxgraph.css"

for page in "${ROUTE_ALIASES[@]}"; do
  cp web-site.html "${OUT_DIR}/${page}.html"
done

echo "-- Syncing new site into old-site /new mirror --"
mkdir -p "${OLD_SITE_NEW_DIR}"
rm -rf "${OLD_SITE_NEW_DIR:?}/"*
cp -a "${OUT_DIR}/". "${OLD_SITE_NEW_DIR}/"

echo "-- Done --"
if [[ "$(uname)" == "Darwin" ]]; then
  afplay /System/Library/Sounds/Glass.aiff || true
fi
